# 着信を拒否したい

通話で着信ハンドラーの動作を不許可にしたくなる場合があるかもしれません。着信ごとに料金がかかり、時間の経過とともに、どうでもいい電話や出たくない電話が蓄積されていくような場合です。一般的な事例としては、迷惑電話の回避が挙げられます。

良いニュースです!発信者の電話が迷惑電話であることが判明している場合は、着信を`<Reject>`(拒否)でき、着信料金も支払う必要はありません。`reason`属性を`"busy"`または`"rejected"`のいずれかに設定し、フローを変更できます。例: `<Reject reason="busy">`

この宝箱に関しては、迷惑電話の疑いのある電話番号を定義し、その番号からの電話をすべて拒否します。この場合、相手にはビジー信号が提供されます。

## 関数の記述

何らかのダイナミックソリューションを使用すると、この課題を解決できます。Twilio Functionsを使用し、この問題を解決する方法を説明します。

コンソールで[Runtime] > [Functions]の順に移動し、新しい関数を作成します。ここで[**+**]ボタンを押し、[**Blank**]テンプレートを選択します。関数の**関数名**を`No spammers allowed`とし、パスを`/no-spammers`とします。ここでまず、着信拒否のテストに使用可能な本物の電話番号を考えてください。

疑似コードは、次のようになります。

- 着信番号が、迷惑電話テスト用の番号と一致した場合は、次のようになります。
  - 着信が拒否され、ビジー信号が送られます。
- または、
  - 「こんにちわ、電話をお待ちしていました」などと応じます。

みなさんの関数スキルを駆使し、挑戦してみてください。ヘルプが必要な場合はスポイラーをチェックしてください。

<details>
    <summary>スポイラー: 関数ソリューション</summary>
`event`オブジェクトには、呼び出し元の情報を保管する`From`を含め、すべてのTwilioリクエスト値があることに注意してください。

```javascript
exports.handler = function(context, event, callback) {
  const twiml = new Twilio.twiml.VoiceResponse();
  if (event.From === '+12095550136') {
    twiml.reject({ reason: 'busy' });
  } else {
    twiml.say('Hello my trustworthy friend');
  }
  callback(null, twiml);
};
```

すべてのVoice TwiML動詞は`VoiceResponse`オブジェクトから公開されるため、rejectメソッドを呼び出してそのタグを生成できます。パラメーターがJavaScriptオブジェクトとしてどのように含まれているかに注意してください。キーは属性名であり、値は値です。

</details>
## 動作を検証

関数を着信番号(\<%= env.TQ_TWILIO_NUMBER.value %>)に関連付け、迷惑電話の疑いのある番号から電話をかけてみます。ビジー信号が聞こえるはずです。では、別の番号から電話をかけてみましょう。人の声のメッセージが聞こえるはずです。

すべてを設定し、次に進みます。迷惑電話の番号を入力し、[**HACK**]ボタンを押してください。

## 詳細はこちら

- [チュートリアル - 迷惑電話とロボコールのブロック](https://www.twilio.com/docs/voice/tutorials/block-spam-calls-and-robocalls-node-js)